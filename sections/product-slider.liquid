{%- assign per_row = section.settings.per_row -%}
{%- assign product_limit = per_row | times: section.settings.rows -%}
{%- assign collection = collections[section.settings.home_featured_products] -%}

{%- if section.settings.divider -%}<div class="section--divider">{%- endif -%}

<div
  id="CollectionSection-{{ section.id }}"
  data-section-id="{{ section.id }}"
  data-section-type="collection-grid"
  data-context="featured-collection">
  {%- if section.settings.title != blank or section.settings.view_all -%}
    <div class="page-width">
      <div class="section-header{% if section.settings.view_all %}{% unless settings.type_headers_align_text %} section-header--with-link{% endunless %}{% endif %}">
        <h2 class="section-header__title">
          {{ section.settings.title }}
        </h2>
        {%- if section.settings.view_all and section.settings.rows == 1 -%}
          <a href="{{ collections[section.settings.home_featured_products].url }}" class="btn btn--secondary btn--small section-header__link">{{ 'collections.general.all_of_collection' | t }}</a>
        {%- endif -%}

        <!-- custom controls -->
    <div class="flickity-controls" aria-hidden="false">
      <button class="flickity-button flickity-prev-custom"
              type="button"
              role="button"
              aria-label="Previous slide"
              aria-disabled="false"
              tabindex="0">
        <!-- left arrow -->
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
      </button>

      <button class="flickity-button flickity-next-custom"
              type="button"
              role="button"
              aria-label="Next slide"
              aria-disabled="false"
              tabindex="0">
        <!-- right arrow -->
        <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/>
        </svg>
      </button>
    </div>
      </div>
    </div>
  {%- endif -%}

  <div class="page-width{% if section.settings.mobile_scrollable %} page-width--flush-small{% endif %}">
    <div{% if section.settings.mobile_scrollable %} class="grid-overflow-wrapper"{% endif %}>
      <div id="productSlider-{{ section.id }}" class="grid grid--uniform product-slider js-product-slide"{% if section.settings.mobile_scrollable %} data-aos="overflow__animation"{% endif %}
      >
        {%- liquid
          capture gridView
            render 'products_per_row', products_per_row: per_row, style: 'fractions'
          endcapture

          if section.settings.mobile_scrollable
            assign fallback = '39vw'
          else
            assign fallback = 'variable'
          endif
        -%}

        {%- if section.settings.home_featured_products == blank or collections[section.settings.home_featured_products].empty? or collections[section.settings.home_featured_products].products_count == 0 -%}

          {%- unless emptyState -%}
            {%- assign emptyState = true -%}
          {%- endunless -%}

          <div class="grid__item">
            <div class="grid grid--uniform">
              {%- for i in (1..product_limit) -%}
                <div class="grid__item grid-product {{ gridView }}" data-aos="row-of-{{ per_row }}">
                  <div class="grid-product__content">
                    <a href="{{ product.url | within: collection }}" class="grid-product__link">
                      <div class="grid-product__image-mask">
                        {%- capture current -%}{% cycle 1, 2, 3, 4, 5, 6 %}{%- endcapture -%}
                        <div class="image-wrap">{{ 'product-' | append: current | placeholder_svg_tag: 'placeholder-svg' }}</div>
                      </div>
                      <div class="grid-product__meta">
                        <div class="grid-product__title">{{ 'home_page.onboarding.product_title' | t }}</div>
                        <div class="grid-product__price">$29</div>
                      </div>
                    </a>
                  </div>
                </div>
              {%- endfor -%}
            </div>
          </div>

        {%- else -%}

          {%- for product in collections[section.settings.home_featured_products].products limit: product_limit -%}
            {%- render 'product-grid-item',
              product: product,
              collection: collection,
              per_row: per_row,
              quick_shop_enable: settings.quick_shop_enable,
              fallback: fallback,
            -%}
          {%- endfor -%}

          {%- if section.settings.view_all -%}

            {%- if section.settings.rows > 1 -%}
              <div class="grid__item text-center{% if section.settings.mobile_scrollable %} small--hide{% endif %}">
                <a href="{{ collections[section.settings.home_featured_products].url }}" class="btn">{{ 'collections.general.all_of_collection' | t }}</a>
              </div>
            {%- endif -%}

            {%- if section.settings.mobile_scrollable -%}
              <div class="grid__item grid__item--view-all text-center {{ gridView }} medium-up--hide">
                <a href="{{ collections[section.settings.home_featured_products].url }}" class="grid-product__see-all">
                  {{ 'collections.general.view_all_products_html' | t: count: collection.products_count }}
                </a>
              </div>
            {%- endif -%}

          {%- endif -%}

        {%- endif -%}
      </div>
    </div>
  </div>
</div>

{%- if section.settings.divider -%}</div>{%- endif -%}

<script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script>

<script>
    // initialize Flickity (if you prefer JS-init instead of data-attribute):
    var carouselElem = document.querySelector('#productSlider-{{ section.id }}');
    var flkty = new Flickity(carouselElem, {
      cellAlign: 'left',
      contain: true,
      pageDots: false,
      prevNextButtons: false, // important: disable Flickity's built-in buttons
      wrapAround: false       // set to true if you want arrows to never disable
    });

    // custom buttons
    var prevBtn = document.querySelector('.flickity-prev-custom');
    var nextBtn = document.querySelector('.flickity-next-custom');

    prevBtn.addEventListener('click', function () { flkty.previous(); });
    nextBtn.addEventListener('click', function () { flkty.next(); });

    // keyboard activation (Enter / Space)
    [prevBtn, nextBtn].forEach(function(btn){
      btn.addEventListener('keydown', function(e){
        if (e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar') {
          e.preventDefault();
          btn.click();
        }
      });
    });

    // update disabled state for non-wrapAround carousels
    function updateDisabledState() {
      if (flkty.options.wrapAround) {
        prevBtn.setAttribute('aria-disabled', 'false');
        nextBtn.setAttribute('aria-disabled', 'false');
        return;
      }
      var selected = flkty.selectedIndex;
      var lastIndex = flkty.slides.length - 1;
      prevBtn.setAttribute('aria-disabled', selected === 0 ? 'true' : 'false');
      nextBtn.setAttribute('aria-disabled', selected === lastIndex ? 'true' : 'false');
    }

    // initial state + after selection changes
    updateDisabledState();
    flkty.on('select', updateDisabledState);

    // Optional: support for external controls (e.g., enable/disable from code)
    // Example: flkty.next(), flkty.previous(), flkty.select(2), etc.
  </script>

  <style>
    #CollectionSection-{{ section.id }} .section-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #CollectionSection-{{ section.id }} .flickity-controls {
      display: flex;
      gap: 10px;
    }
    #CollectionSection-{{ section.id }} .flickity-controls button {
      width: 20px;
      height: 20px;
      position: relative;
      background: transparent;
      border-radius: 0;
    }
  </style>

{% schema %}
{
  "name": "Product Slider",
  "class": "index-section",
  "settings": [
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "t:sections.featured-collection.settings.title.label",
      "default": "Featured collection"
    },
    {
      "type": "collection",
      "id": "home_featured_products",
      "label": "t:sections.featured-collection.settings.home_featured_products.label"
    },
    {
      "type": "range",
      "id": "per_row",
      "label": "t:sections.featured-collection.settings.per_row.label",
      "default": 4,
      "min": 1,
      "max": 5,
      "step": 1
    },
    {
      "type": "range",
      "id": "rows",
      "label": "t:sections.featured-collection.settings.rows.label",
      "default": 2,
      "min": 1,
      "max": 5,
      "step": 1
    },
    {
      "type": "checkbox",
      "id": "view_all",
      "label": "t:sections.featured-collection.settings.view_all.label",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "divider",
      "label": "t:sections.featured-collection.settings.divider.label",
      "default": false
    }
  ],
  "presets": [
    {
      "name": "Product Slider"
    }
  ],
  "blocks": [],
  "disabled_on": {
    "groups": ["footer", "header", "custom.popups"]
  }
}
{% endschema %}